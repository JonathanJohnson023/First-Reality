name: Dev Environment Deployment

on:
  push:
    branches: [ dev ]
  pull_request:
    branches: [ dev ]

jobs:
  deploy-dev:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Run unit tests
      run: npm run test:unit || echo "Unit tests not yet implemented"
      
    - name: Run E2E tests
      run: npm run test:e2e || echo "E2E tests not yet implemented"
      
    - name: Build project
      run: NODE_OPTIONS="--openssl-legacy-provider" npm run build
      
    - name: Prepare dev deployment
      run: |
        mkdir -p dev-deploy
        cp index.html dev-deploy/
        cp -r dist/ dev-deploy/
        cp -r styles/ dev-deploy/
        cp -r assets/ dev-deploy/ || echo "Assets not found"
        cp *.png dev-deploy/ || echo "PNG files not found"
        touch dev-deploy/.nojekyll
        
        # Add dev environment indicator
        sed -i 's|<title>First Reality</title>|<title>First Reality - DEV</title>|g' dev-deploy/index.html
        
        # Add dev banner
        sed -i 's|<body>|<body><div style="position:fixed;top:0;left:0;width:100%;background:#ff9800;color:black;text-align:center;padding:5px;z-index:10000;font-weight:bold;">🚧 DEV ENVIRONMENT 🚧</div>|g' dev-deploy/index.html
        
    - name: Deploy to dev environment
      if: github.ref == 'refs/heads/dev'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dev-deploy
        destination_dir: dev
        keep_files: true
        enable_jekyll: false
        commit_message: "🚀 Deploy to dev environment"
        
    - name: Verify dev deployment
      if: github.ref == 'refs/heads/dev'
      run: |
        sleep 60
        DEV_URL="https://jonathanjohnson023.github.io/First-Reality/dev/"
        
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$DEV_URL")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "✅ Dev deployment successful!"
          echo "🔧 Dev URL: $DEV_URL"
        else
          echo "❌ Dev deployment failed - HTTP $HTTP_CODE"
          exit 1
        fi
        
    - name: Comment on PR (Dev)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const comment = \`## 🔧 Dev Environment Ready!
          
          ### ✅ Build Status: SUCCESS
          - Tests passed ✅
          - Build completed ✅
          - Ready for dev deployment ✅
          
          ### 🔧 When merged to dev:
          **Dev URL**: https://jonathanjohnson023.github.io/First-Reality/dev/
          
          ### 🧪 Testing Required:
          - [ ] Game loads without errors
          - [ ] Enter key works on title screen
          - [ ] Volume controls functional
          - [ ] Combat system works
          - [ ] Mobile responsive
          
          **Merge to deploy to dev environment!** 🚀\`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });