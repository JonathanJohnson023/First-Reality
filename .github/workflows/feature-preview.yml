name: Feature Branch Preview Deployment

on:
  push:
    branches: [ 'feature/**', 'cursor/**' ]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
    - name: Checkout source code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Build project
      run: NODE_OPTIONS="--openssl-legacy-provider" npm run build
      
    - name: Prepare preview deployment
      run: |
        echo "🚀 Preparing preview deployment for ${{ github.ref_name }}"
        
        # Create clean deployment directory
        rm -rf preview-deploy
        mkdir -p preview-deploy
        
        # Copy all necessary files
        cp index.html preview-deploy/
        cp -r dist/ preview-deploy/
        cp -r styles/ preview-deploy/
        cp -r assets/ preview-deploy/ || echo "Assets directory not found"
        cp *.png preview-deploy/ || echo "PNG files not found"
        
        # Create .nojekyll file
        touch preview-deploy/.nojekyll
        
        # Create a simple test page to verify deployment
        cat > preview-deploy/test.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head><title>Preview Test - ${{ github.ref_name }}</title></head>
        <body>
            <h1>✅ Preview Deployment Working!</h1>
            <p>Branch: <strong>${{ github.ref_name }}</strong></p>
            <p>Deployed: <strong>$(date)</strong></p>
            <p><a href="./index.html">→ Go to Game</a></p>
        </body>
        </html>
        EOF
        
        echo "📁 Preview deployment contents:"
        ls -la preview-deploy/
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./preview-deploy
        destination_dir: preview/${{ github.ref_name }}
        keep_files: false
        force_orphan: false
        enable_jekyll: false
        commit_message: "🚀 Deploy preview for ${{ github.ref_name }}"
        
    - name: Verify deployment
      run: |
        echo "✅ Preview deployment completed!"
        echo ""
        echo "🎮 Preview URLs:"
        echo "Main Game: https://jonathanjohnson023.github.io/First-Reality/preview/${{ github.ref_name }}/"
        echo "Test Page: https://jonathanjohnson023.github.io/First-Reality/preview/${{ github.ref_name }}/test.html"
        echo ""
        echo "⏱️ Note: GitHub Pages may take 5-10 minutes to propagate"
        echo ""
        echo "🔍 Troubleshooting:"
        echo "1. Check GitHub Pages settings: https://github.com/${{ github.repository }}/settings/pages"
        echo "2. Ensure source is set to 'Deploy from a branch' → 'gh-pages' → '/ (root)'"
        echo "3. Wait 5-10 minutes for DNS propagation"
        
    - name: Create deployment comment
      uses: actions/github-script@v7
      with:
        script: |
          const branchName = '${{ github.ref_name }}';
          const previewUrl = `https://jonathanjohnson023.github.io/First-Reality/preview/${branchName}/`;
          const testUrl = `https://jonathanjohnson023.github.io/First-Reality/preview/${branchName}/test.html`;
          
          const comment = `## 🚀 Feature Preview Deployed!
          
          ### ✅ Deployment Status: **SUCCESS**
          - **Branch**: \`${branchName}\`
          - **Deployed**: ${new Date().toLocaleString()}
          - **Commit**: \`${{ github.sha }}\`
          
          ### 🎮 **Test Your Changes**
          - **Preview URL**: [${previewUrl}](${previewUrl})
          - **Test Page**: [${testUrl}](${testUrl})
          
          ### ⏱️ **Important Notes**
          - GitHub Pages may take **5-10 minutes** to propagate
          - If you get 404, wait a few minutes and refresh
          - Test page should load first, then try the main game
          
          ### 🔍 **Troubleshooting**
          If you still get 404 after 10 minutes:
          1. Check [GitHub Pages settings](https://github.com/${{ github.repository }}/settings/pages)
          2. Ensure source is set to "Deploy from a branch" → "gh-pages" → "/ (root)"
          3. Repository must be public for GitHub Pages to work
          
          ### 🌟 **Features to Test**
          - 🔊 Volume controls and auto-mute title screen
          - 💾 Save system with auto-save
          - ⚔️ Enhanced combat system
          - 📱 Mobile touch controls
          - 🎨 Animations and effects
          
          **Test the preview, then merge when ready!** 🚀`;
          
          // We can't comment on commits, but we can log this info
          console.log(comment);