name: Feature Branch Testing

on:
  push:
    branches: 
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'

jobs:
  test-feature:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: Run tests
      run: npm test
      
    - name: Build project
      run: NODE_OPTIONS="--openssl-legacy-provider" npm run build
      
    - name: Verify build
      run: |
        if [ ! -f "dist/bundle.js" ]; then
          echo "❌ Build failed"
          exit 1
        fi
        echo "✅ Build successful - $(du -h dist/bundle.js | cut -f1)"
        
    - name: Create deployment artifact
      run: |
        # Create deployment package for manual testing
        mkdir -p feature-package
        cp index.html feature-package/
        cp -r dist/ feature-package/
        cp -r styles/ feature-package/
        cp -r assets/ feature-package/ || echo "Assets not found"
        cp *.png feature-package/ || echo "PNG files not found"
        touch feature-package/.nojekyll
        
        # Add feature identifier
        sed -i 's|<title>First Reality</title>|<title>First Reality - ${{ github.ref_name }}</title>|g' feature-package/index.html
        sed -i 's|<body>|<body><div style="position:fixed;top:0;left:0;width:100%;background:#4CAF50;color:black;text-align:center;padding:8px;z-index:10000;font-weight:bold;">🌟 FEATURE: ${{ github.ref_name }} 🌟</div><div style="height:40px;"></div>|g' feature-package/index.html
        
        # Create simple test instructions
        cat > feature-package/TEST-INSTRUCTIONS.md << 'EOF'
        # Feature Branch Testing Instructions
        
        ## Quick Test
        1. Download this repository branch
        2. Run: `python3 -m http.server 8000`
        3. Open: http://localhost:8000
        4. Test all functionality
        
        ## What to Test
        - [ ] Game loads without console errors
        - [ ] Enter key works on title screen
        - [ ] Volume controls visible and functional
        - [ ] Combat system works
        - [ ] Mobile responsive
        
        ## Ready for PR
        If all tests pass, create PR to dev branch.
        EOF
        
        echo "📦 Feature package created for testing"
        
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: feature-${{ github.ref_name }}-deployment
        path: feature-package/
        retention-days: 7
        
    - name: Feature testing complete
      run: |
        echo "🎮 FEATURE BRANCH TESTING COMPLETE!"
        echo ""
        echo "✅ Build successful"
        echo "✅ Tests passed"
        echo "✅ Deployment package created"
        echo ""
        echo "📦 Download deployment artifact to test locally"
        echo "🔗 Artifact: feature-${{ github.ref_name }}-deployment"
        echo ""
        echo "🚀 Ready to create PR to dev branch when testing complete!"