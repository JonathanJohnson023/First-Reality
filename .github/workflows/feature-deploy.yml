name: ğŸŒŸ Feature Branch Auto-Deploy

on:
  push:
    branches: 
      - 'feature/**'
      - 'fix/**'
      - 'hotfix/**'

jobs:
  deploy-feature:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“‹ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¦ Setup Node.js Environment  
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ”§ Install Dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm cache clean --force
        npm install --legacy-peer-deps
        echo "âœ… Dependencies installed successfully"
        
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running test suite..."
        npm test
        echo "âœ… All tests passed"
        
    - name: ğŸ”¨ Build Project
      run: |
        echo "ğŸ”¨ Building project for feature branch: ${{ github.ref_name }}"
        NODE_OPTIONS="--openssl-legacy-provider" npm run build
        echo "âœ… Build completed successfully"
        
    - name: ğŸ“Š Verify Build Output
      run: |
        echo "ğŸ“Š Build verification:"
        if [ ! -f "dist/bundle.js" ]; then
          echo "âŒ Build failed - bundle.js not found"
          exit 1
        fi
        
        BUNDLE_SIZE=$(du -h dist/bundle.js | cut -f1)
        echo "âœ… Bundle created: $BUNDLE_SIZE"
        
        echo "ğŸ“ Build artifacts:"
        ls -la dist/
        
        echo "ğŸ“‹ Deployment files ready:"
        echo "- index.html: $(du -h index.html | cut -f1)"
        echo "- dist/bundle.js: $BUNDLE_SIZE"
        echo "- styles/: $(du -sh styles/ | cut -f1)"
        echo "- assets/: $(du -sh assets/ 2>/dev/null | cut -f1 || echo 'Not found')"
        
    - name: ğŸ·ï¸ Add Feature Branch Identifier
      run: |
        echo "ğŸ·ï¸ Adding feature branch identifier..."
        
        # Add feature banner (small, clean)
        sed -i 's|<body>|<body><div style="position:fixed;top:0;left:0;width:100%;background:#4CAF50;color:black;text-align:center;padding:4px;z-index:10000;font-size:12px;font-weight:bold;">ğŸŒŸ FEATURE: ${{ github.ref_name }} ğŸŒŸ</div><div style="height:25px;"></div>|g' index.html
        
        # Update title
        sed -i 's|<title>First Reality</title>|<title>First Reality - ${{ github.ref_name }}</title>|g' index.html
        
        echo "âœ… Feature identifier added"
        
    - name: ğŸš€ Deploy to Netlify
      uses: nwtgck/actions-netlify@v3.0
      with:
        publish-dir: './'
        production-branch: master
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "ğŸŒŸ Feature deploy: ${{ github.ref_name }} - ${{ github.sha }}"
        enable-pull-request-comment: false
        enable-commit-comment: false
        overwrites-pull-request-comment: false
        alias: ${{ github.ref_name }}
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        
    - name: ğŸ” Verify Feature Deployment
      run: |
        echo "ğŸ” Verifying feature deployment..."
        
        # Generate expected URL
        BRANCH_NAME="${{ github.ref_name }}"
        SAFE_BRANCH=$(echo "$BRANCH_NAME" | tr '/' '-' | tr '[:upper:]' '[:lower:]')
        FEATURE_URL="https://${SAFE_BRANCH}--first-reality.netlify.app/"
        
        echo "ğŸ¯ Expected URL: $FEATURE_URL"
        echo "â±ï¸ Waiting for Netlify deployment to complete..."
        
        # Wait for deployment
        sleep 60
        
        # Test deployment
        echo "ğŸ” Testing deployment..."
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$FEATURE_URL" || echo "000")
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "âœ… Feature deployment successful!"
          echo "ğŸ® Live URL: $FEATURE_URL"
          
          # Test key components
          CONTENT=$(curl -s "$FEATURE_URL" 2>/dev/null || echo "")
          
          if echo "$CONTENT" | grep -q "volume-controls"; then
            echo "âœ… Volume controls deployed"
          else
            echo "âš ï¸ Volume controls not found"
          fi
          
          if echo "$CONTENT" | grep -q "Press Enter"; then
            echo "âœ… Title screen deployed"
          else
            echo "âš ï¸ Title screen not found"
          fi
          
          # Test bundle
          BUNDLE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${FEATURE_URL}dist/bundle.js" || echo "000")
          if [ "$BUNDLE_CODE" = "200" ]; then
            echo "âœ… Game bundle loads correctly"
          else
            echo "âš ï¸ Game bundle issue - HTTP $BUNDLE_CODE"
          fi
          
        else
          echo "âš ï¸ Deployment still propagating - HTTP $HTTP_CODE"
          echo "ğŸ”„ Try URL in 2-3 minutes: $FEATURE_URL"
        fi
        
        echo ""
        echo "ğŸ® FEATURE TESTING READY!"
        echo "ğŸ”— URL: $FEATURE_URL"
        echo "ğŸ“ Test checklist:"
        echo "  - [ ] Game loads without errors"
        echo "  - [ ] Enter key works on title screen"
        echo "  - [ ] Volume controls functional"
        echo "  - [ ] Combat system works"
        echo "  - [ ] No performance issues"
        echo ""
        echo "âœ… Ready to create PR to dev when testing complete!"