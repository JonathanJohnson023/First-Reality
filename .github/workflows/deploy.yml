name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master, cursor/improve-app-fix-combat-add-volume-and-mute-e839 ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Clear npm cache
      run: npm cache clean --force
        
    - name: Install dependencies
      run: |
        npm cache clean --force
        npm install --legacy-peer-deps
      
    - name: Build project
      run: |
        echo "ğŸ”§ Node.js version: $(node --version)"
        echo "ğŸ“¦ NPM version: $(npm --version)"
        
        # Try the custom build script first
        if node build-ci.js; then
          echo "âœ… Custom build script succeeded"
        else
          echo "âš ï¸ Custom build failed, trying fallback..."
          
          # Fallback: try without legacy provider on Node 18
          if npx webpack --mode=production; then
            echo "âœ… Fallback build succeeded"
          else
            echo "âŒ Both build methods failed"
            exit 1
          fi
        fi
      
    - name: Create assets directory
      run: mkdir -p assets
      
    - name: Verify build output
      run: |
        echo "ğŸ” Verifying build output..."
        ls -la dist/
        
        # Check if required files exist
        if [ -f "dist/bundle.js" ]; then
          echo "âœ… bundle.js exists ($(du -h dist/bundle.js | cut -f1))"
        else
          echo "âŒ bundle.js missing!"
          exit 1
        fi
        
        if [ -f "index.html" ]; then
          echo "âœ… index.html exists"
        else
          echo "âŒ index.html missing!"
          exit 1
        fi
        
        echo "ğŸ‰ Build verification complete!"
        
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/cursor/improve-app-fix-combat-add-volume-and-mute-e839'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        exclude_assets: '.github,node_modules,src,*.md,package*.json,webpack.config.js,.gitignore,TODOS.md'
        
    - name: Comment deployment URL
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/cursor/improve-app-fix-combat-add-volume-and-mute-e839')
      run: |
        echo "ğŸš€ Deployment completed!"
        echo "ğŸ® Game URL: https://jonathanjohnson023.github.io/First-Reality"
        echo "ğŸ“Š Build artifacts:"
        ls -la dist/
        
    - name: Deploy Preview (PR)
      if: github.event_name == 'pull_request'
      run: |
        echo "âœ… Build successful! Ready for deployment."
        echo "ğŸ“¦ Built files:"
        ls -la dist/