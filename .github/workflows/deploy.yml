name: Deploy to GitHub Pages

on:
  push:
    branches: [ main, master, 'feature/**', 'cursor/**' ]
  pull_request:
    branches: [ main, master ]
  delete:
    branches: [ 'feature/**', 'cursor/**' ]

jobs:
  cleanup-deleted-branch:
    if: github.event_name == 'delete'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - name: Checkout gh-pages branch
      uses: actions/checkout@v4
      with:
        ref: gh-pages
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Cleanup deleted feature branch preview
      run: |
        echo "ğŸ—‘ï¸ Cleaning up preview for deleted branch: ${{ github.event.ref }}"
        
        # Remove the preview directory
        if [ -d "preview/${{ github.event.ref }}" ]; then
          rm -rf "preview/${{ github.event.ref }}"
          echo "âœ… Removed preview/${{ github.event.ref }}/"
          
          # Commit the cleanup
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "ğŸ—‘ï¸ Cleanup preview for deleted branch ${{ github.event.ref }}" || echo "Nothing to commit"
          git push
        else
          echo "âš ï¸ Preview directory not found: preview/${{ github.event.ref }}"
        fi
        
  build-and-deploy:
    if: github.event_name != 'delete'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      pull-requests: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Clear npm cache
      run: npm cache clean --force
        
    - name: Install dependencies
      run: |
        npm cache clean --force
        npm install --legacy-peer-deps
      
    - name: Build project
      run: |
        echo "ğŸ”§ Node.js version: $(node --version)"
        echo "ğŸ“¦ NPM version: $(npm --version)"
        
        # Try the custom build script first
        if node build-ci.js; then
          echo "âœ… Custom build script succeeded"
        else
          echo "âš ï¸ Custom build failed, trying fallback..."
          
          # Fallback: try without legacy provider on Node 18
          if npx webpack --mode=production; then
            echo "âœ… Fallback build succeeded"
          else
            echo "âŒ Both build methods failed"
            exit 1
          fi
        fi
      
    - name: Create assets directory
      run: mkdir -p assets
      
    - name: Verify build output
      run: |
        echo "ğŸ” Verifying build output..."
        ls -la dist/
        
        # Check if required files exist
        if [ -f "dist/bundle.js" ]; then
          echo "âœ… bundle.js exists ($(du -h dist/bundle.js | cut -f1))"
        else
          echo "âŒ bundle.js missing!"
          exit 1
        fi
        
        if [ -f "index.html" ]; then
          echo "âœ… index.html exists"
        else
          echo "âŒ index.html missing!"
          exit 1
        fi
        
        echo "ğŸ‰ Build verification complete!"
        
    - name: Prepare deployment files
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/cursor/')
      run: |
        # Create deployment directory
        mkdir -p deploy
        
        # Copy necessary files for deployment
        cp index.html deploy/
        cp -r dist/ deploy/
        cp -r styles/ deploy/
        cp -r assets/ deploy/ || echo "Assets directory not found, skipping"
        cp *.png deploy/ || echo "PNG files not found, skipping"
        cp first_reality_ff.png deploy/ || echo "Favicon not found, skipping"
        
        # Create .nojekyll to disable Jekyll processing
        touch deploy/.nojekyll
        
        echo "âœ… Deployment files prepared"
        ls -la deploy/
        
    - name: Deploy to GitHub Pages (Production)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        force_orphan: true
        enable_jekyll: false
        
    - name: Debug feature branch deployment
      if: startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/cursor/')
      run: |
        echo "ğŸ” Debug Info:"
        echo "Branch: ${{ github.ref }}"
        echo "Branch name: ${{ github.ref_name }}"
        echo "Event: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo ""
        echo "ğŸ“ Deploy directory contents:"
        ls -la deploy/
        echo ""
        echo "ğŸ¯ Will deploy to: preview/${{ github.ref_name }}/"
        
    - name: Deploy Feature Branch Preview
      if: startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/cursor/')
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./deploy
        destination_dir: preview/${{ github.ref_name }}
        keep_files: true
        enable_jekyll: false
        commit_message: "Deploy preview for ${{ github.ref_name }}"
        
    - name: Create preview index (Feature Branch)
      if: startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/cursor/')
      run: |
        # Create a simple index page for the preview
        mkdir -p preview_index
        cat > preview_index/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <title>First Reality - Feature Previews</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #0f3460; color: white; }
                .preview-link { 
                    display: block; 
                    padding: 20px; 
                    margin: 10px 0; 
                    background: rgba(255,255,255,0.1); 
                    border-radius: 8px; 
                    text-decoration: none; 
                    color: white;
                    border: 2px solid rgba(255,255,255,0.2);
                    transition: all 0.3s ease;
                }
                .preview-link:hover {
                    background: rgba(255,255,255,0.2);
                    border-color: #4CAF50;
                    transform: translateY(-2px);
                }
                h1 { color: #4CAF50; }
            </style>
        </head>
        <body>
            <h1>ğŸ® First Reality - Feature Previews</h1>
            <p>Available feature branch previews:</p>
            <a href="./preview/${{ github.ref_name }}/" class="preview-link">
                <strong>${{ github.ref_name }}</strong><br>
                <small>Latest deployment: $(date)</small>
            </a>
            <p><a href="../" style="color: #4CAF50;">â† Back to Production</a></p>
        </body>
        </html>
        EOF
        
        echo "âœ… Preview index created for ${{ github.ref_name }}"
        
    - name: Comment deployment URL (Production)
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        echo "ğŸš€ Production Deployment completed!"
        echo "ğŸ® Live Game URL: https://jonathanjohnson023.github.io/First-Reality"
        echo "ğŸ“Š Build artifacts:"
        ls -la dist/
        
    - name: Comment deployment URL (Feature Branch)
      if: github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/cursor/'))
      run: |
        echo "ğŸš€ Feature Branch Deployment completed!"
        echo "ğŸ® Preview URL: https://jonathanjohnson023.github.io/First-Reality/preview/${{ github.ref_name }}/"
        echo "ğŸ“Š Build artifacts:"
        ls -la dist/
        echo ""
        echo "ğŸ” TESTING INSTRUCTIONS:"
        echo "1. Visit the preview URL above"
        echo "2. Test all new features"
        echo "3. Verify mobile responsiveness"
        echo "4. Check audio controls work"
        echo "5. Test save/load functionality"
        echo ""
        echo "âœ… If everything works, merge to deploy to production!"
        
    - name: Deploy Preview (PR)
      if: github.event_name == 'pull_request'
      run: |
        echo "âœ… Build successful! Ready for deployment."
        echo "ğŸ“¦ Built files:"
        ls -la dist/
        echo ""
        echo "ğŸš€ DEPLOYMENT PREVIEW:"
        echo "When this PR is merged, the game will be deployed to:"
        echo "ğŸ® https://jonathanjohnson023.github.io/First-Reality"
        echo ""
        echo "ğŸ“Š Bundle Analysis:"
        echo "- Bundle Size: $(du -h dist/bundle.js | cut -f1)"
        echo "- Total Assets: $(ls dist/ | wc -l) files"
        echo "- Ready for production: âœ…"
        
    - name: Comment PR with deployment info
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const bundleSize = fs.statSync('dist/bundle.js').size;
          const bundleSizeKB = Math.round(bundleSize / 1024 * 10) / 10;
          
          const branchName = context.payload.pull_request.head.ref;
          const previewUrl = `https://jonathanjohnson023.github.io/First-Reality/preview/${branchName}/`;
          
          const comment = `## ğŸš€ Deployment Preview Ready!
          
          ### âœ… Build Status: **SUCCESS**
          - **Bundle Size**: ${bundleSizeKB}KB (optimized)
          - **Build Time**: ${new Date().toLocaleString()}
          - **Status**: Ready for deployment ğŸ¯
          
          ### ğŸ® **Test Your Changes**
          **Feature Branch Preview**: [${previewUrl}](${previewUrl})
          
          ğŸ” **Testing Checklist**:
          - [ ] Game loads and starts correctly
          - [ ] Audio controls work (volume slider, mute button)
          - [ ] Combat system functions properly
          - [ ] Save/load system works
          - [ ] Mobile touch controls responsive
          - [ ] All animations smooth
          
          ### ğŸ® **When Merged**
          Production deployment: **https://jonathanjohnson023.github.io/First-Reality**
          
          ### ğŸŒŸ **New Features Included**
          - ğŸ”Š Professional audio system (15+ sound effects)
          - ğŸ’¾ Advanced save system with auto-save
          - ğŸ“± Mobile touch controls
          - âš”ï¸ 99-level progression system
          - ğŸ¨ Premium animations and effects
          - ğŸ”‡ Auto-mute title screen
          - ğŸšï¸ Volume slider controls
          
          ### ğŸ“Š **Performance**
          - **Load Time**: Optimized for fast loading
          - **Mobile Ready**: Touch controls implemented
          - **Cross-Browser**: Compatible with modern browsers
          
          **Test the preview, then merge to deploy to production!** ğŸš€`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });